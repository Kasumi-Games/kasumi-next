# 邮箱系统 (Mailbox) 📮

Kasumi Next 的完整邮件系统，支持定时邮件、奖励发放、群发通知等功能。

## ✨ 功能特性

### 👤 用户功能
- 📮 查看邮箱中的邮件列表
- 📧 读取邮件内容并自动领取奖励
- ⏰ 邮件过期自动清理
- 🎁 支持星之碎片奖励

### 👑 管理员功能
- 📅 创建和管理定时邮件
- 📊 查看邮件系统统计信息
- 🎯 灵活的时间调度系统
- 🔄 自动化邮件处理

## 🎮 用户命令

### 查看邮箱
```bash
/邮箱
/邮件
/mail
```
显示当前用户的邮件列表，包括未读/已读状态、奖励信息和过期时间。

### 读取邮件
```bash
/邮件 <编号>
/mail <编号>
```
读取指定编号的邮件内容，自动领取附带的星之碎片奖励。

**示例：**
```bash
/邮箱          # 查看邮箱列表
/邮件 1        # 读取第1封邮件
```

## 👑 管理员命令

### 定时邮件管理
```bash
/schedulemail <操作>
/定时邮件 <操作>
```

#### 创建定时邮件
```bash
/schedulemail add -r <接收者> -w <预定时间> -e <过期天数> -k <星之碎片> -t <标题> -c <内容> [--name 自定义名称]
```

**参数说明：**
- `-r, --recipients`: `all` 表示群发，或 `user1,user2,user3` 指定用户
- `-w, --when`: 发送时间（支持绝对和相对时间）
- `-e, --expire`: 邮件过期时间 (1-30天)
- `-k, --kakeras`: 附带星之碎片奖励数量 (0或正整数)
- `-t, --title`: 邮件标题
- `-c, --content`: 邮件正文内容
- `--name`: 可选的自定义邮件名称，不提供时系统自动生成

**时间格式：**
- **绝对时间**: `"2024-01-15 18:00"`, `"2024-01-15"` (默认00:00)
- **相对时间**: `"+1h"` (1小时后), `"+30m"` (30分钟后), `"+1d"` (1天后)

#### 管理定时邮件
```bash
/schedulemail list                                    # 查看所有定时邮件
/schedulemail info <名称>                             # 查看邮件详情
/schedulemail edit <名称> [选项...]                    # 修改邮件（支持多字段同时修改）
/schedulemail delete <名称>                           # 删除邮件
```

**编辑选项：**
- `-t, --title <新标题>` - 修改标题
- `-c, --content <新内容>` - 修改内容  
- `-w, --when <新时间>` - 修改预定时间
- `-k, --kakeras <新数量>` - 修改星之碎片数量
- `-e, --expire <新天数>` - 修改过期天数
- `-r, --recipients <新接收者>` - 修改接收者


## 📝 使用示例

### 维护补偿邮件
```bash
# 创建维护补偿邮件（绝对时间）
/schedulemail add -r all -w "2024-01-15 18:00" -e 7 -k 100 -t 维护补偿 -c "感谢大家的耐心等待，维护已完成！"

# 创建测试邮件（相对时间，自定义名称）
/schedulemail add -r user123 -w "+30m" -e 3 -k 50 -t 测试 -c "这是30分钟后发送的测试邮件" --name 测试邮件

# 查看待发送邮件
/schedulemail list

# 如果维护时间有变化，调整时间和内容
/schedulemail edit mail_1705123456_abc123 -w "2024-01-15 21:30" -c "维护时间延长，补偿增加！"
```

### 活动奖励分批发放
```bash
# 为不同等级的玩家设置不同奖励
/schedulemail add -r user1,user2,user3 -w "+10m" -e 3 -k 500 -t 活动金奖 -c "恭喜获得金奖！" --name 金奖用户
/schedulemail add -r user4,user5,user6 -w "+15m" -e 3 -k 300 -t 活动银奖 -c "恭喜获得银奖！" --name 银奖用户
/schedulemail add -r user7,user8,user9 -w "+20m" -e 3 -k 100 -t 活动铜奖 -c "恭喜获得铜奖！" --name 铜奖用户
```

### 节日祝福邮件
```bash
# 新年祝福邮件
/schedulemail add -r all -w "2024-01-01 00:00" -e 30 -k 2024 -t 新年快乐 -c "祝愿所有玩家新年快乐，万事如意！" --name 新年祝福

# 查看邮件详情
/schedulemail info 新年祝福
```

### 紧急通知处理
```bash
# 查看即将发送的邮件
/schedulemail list

# 取消不需要的邮件
/schedulemail delete mail_1705123456_abc123

# 修改邮件内容和时间（支持多字段同时修改）
/schedulemail edit 紧急通知 -c "更新后的紧急通知内容" -w "+5m" -k 50
```

## ⚙️ 自动化功能

### 定时处理
- **邮件发送**: 每5分钟自动检查并发送到期的定时邮件
- **防重复机制**: 已发送的邮件自动标记，绝不重复发送
- **过期清理**: 每天凌晨3点自动清理过期邮件

### 持久化存储
- **数据库存储**: 所有邮件数据存储在数据库中，系统重启后完整保留
- **状态管理**: 完整的邮件状态跟踪（待发送、已发送、过期等）
- **日志记录**: 详细的操作日志，便于问题排查

## 📋 最佳实践

### 邮件过期时间建议
- **重要奖励邮件**: 7-14天
- **普通通知邮件**: 3-7天
- **节日祝福邮件**: 14-30天
- **紧急通知**: 1-3天

### 星之碎片奖励建议
- **日常签到补偿**: 10-50
- **维护补偿**: 50-200
- **活动奖励**: 100-1000
- **特殊贡献奖励**: 500-2000

### 邮件内容建议
- 标题简洁明了，突出重点
- 内容礼貌友好，表达感谢
- 明确说明获得奖励的原因
- 避免过长的内容，保持简洁

### 批量操作建议
- 重要邮件先发送给管理员测试
- 使用相对时间避免时区问题
- 分批发送大量邮件，避免系统压力
- 定期检查待发送邮件状态

## 🔧 日常维护

### 每日检查
```bash
# 查看待发送邮件
/schedulemail list
```

### 故障排除

**邮件没有按时发送**
1. 检查系统日志确认定时器运行状态
2. 验证邮件预定时间是否正确
3. 确认邮件状态未被意外修改

**修改邮件失败**
1. 确认邮件尚未发送（已发送无法修改）
2. 检查参数格式是否正确
3. 验证管理员权限

**时间格式错误**
- 绝对时间格式: `"2024-01-15 18:00"`
- 相对时间格式: `"+1h"`, `"+30m"`, `"+1d"`

## 🆕 重要特性

### 🤖 自动ID生成
- **系统自动生成唯一邮件ID**，格式为 `mail_时间戳_随机字符`
- **支持自定义名称**，使用 `--name` 参数指定易记的名称
- **无需手动管理ID冲突**，系统确保唯一性

### 📊 数据库优化
- **消除数据重复**，使用规范化设计分离邮件内容和用户状态
- **广播邮件高效**，1封广播邮件不再创建N份重复数据
- **外键关系**，确保数据一致性和级联删除
- **索引优化**，针对常用查询场景建立复合索引

### 🔧 Alconna 命令解析
- **高级命令解析**，基于强大的 [Alconna](https://nonebot.dev/docs/best-practice/alconna/matcher) 框架
- **命名选项支持**，使用 `-r`, `-w`, `-t` 等直观的参数名
- **多字段同时修改**，一条命令修改多个邮件属性
- **自动参数验证**，类型检查和范围验证
- **智能补全提示**，提供参数建议和错误提示

### 📊 统一统计界面
- **合并统计命令**，`/mailstats` 显示所有邮件统计信息
- **简化管理界面**，减少命令记忆负担
- **完整系统概览**，普通邮件和定时邮件一目了然

## 🎯 使用场景

### 1. 服务器维护补偿
维护结束后自动发送补偿邮件给所有玩家

### 2. 活动奖励发放
为参与活动的用户分批发送不同等级的奖励

### 3. 系统通知广播
重要更新或公告信息的定时发送

### 4. 个人专属奖励
为特定用户发送个性化的奖励邮件

### 5. 节日祝福活动
在特殊节日自动发送祝福和礼品

## 🔄 系统优势

✅ **无需手动操作** - 完全命令行管理，无需编辑配置文件  
✅ **自动定时处理** - 系统每5分钟自动检查并发送到期邮件  
✅ **防重复发送** - 数据库状态管理，确保邮件只发送一次  
✅ **持久化存储** - 系统重启后所有数据完整保留  
✅ **灵活时间设置** - 支持绝对时间和相对时间格式  
✅ **完整管理功能** - 创建、查看、修改、删除、统计一应俱全  
✅ **详细日志记录** - 所有操作都有完整的日志跟踪  

## ⚠️ 注意事项

1. **权限要求**: 管理员命令需要超级用户权限
2. **邮件过期**: 过期邮件会自动删除，无法恢复
3. **奖励发放**: 星之碎片奖励在读取邮件时自动发放
4. **唯一标识**: 定时邮件名称必须唯一，不能重复
5. **修改限制**: 已发送的邮件无法修改或删除
6. **系统监控**: 建议定期查看统计信息，监控系统状态
